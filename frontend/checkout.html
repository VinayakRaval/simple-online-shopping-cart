<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout — ShopSmart</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    body{background:linear-gradient(180deg,#0b1220,#0f172a);color:#e6eef8;font-family:Poppins,system-ui;margin:0}
    .checkout-container{max-width:760px;margin:40px auto;background:#0b1228;padding:24px;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    h2{color:#00b4db;margin:0 0 14px}
    label{display:block;margin:12px 0 6px;color:#9fb6c7}
    input, textarea{width:100%;padding:12px;border-radius:8px;border:none;background:#071427;color:#e6eef8;outline:none}
    .summary{background:#071827;padding:12px;border-radius:8px;margin-bottom:12px}
    .actions{display:flex;gap:12px;align-items:center}
    .btn{background:#00b4db;color:#02121a;padding:10px 16px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;color:#e6eef8;border:1px solid rgba(255,255,255,0.06)}
    .small{font-size:0.9rem;color:#b6c8d8}
  </style>
</head>
<body>
  <div id="header-root"></div>
  <script>fetch("components/header.html").then(r=>r.text()).then(h=>document.getElementById("header-root").innerHTML=h);</script>

  <div class="checkout-container">
    <h2>Customer Details</h2>

    <div id="selectedProduct" class="summary" style="display:none;"></div>

    <form id="checkoutForm">
      <label>Full name</label>
      <input id="name" required />

      <label>Address</label>
      <textarea id="address" rows="3" required></textarea>

      <label>Phone</label>
      <input id="phone" type="tel" required />

      <div style="margin-top:12px" class="actions">
        <button type="submit" class="btn" id="placeOrderBtn">Place Order</button>
        <button type="button" class="btn secondary" id="cancelBtn">Cancel</button>
      </div>
      <p class="small" style="margin-top:10px">Payment: Cash on Delivery (COD) — payment step removed as requested.</p>
    </form>
  </div>

  <div id="toast-container"></div>

  <script>
    
  if (!localStorage.getItem("token") || localStorage.getItem("role") !== "user") {
    alert("Please log in as a user!");
    window.location.href = "login.html";
  }

  const ORDERS_API = "http://127.0.0.1:5000/api/orders";
  const USERS_API = "http://127.0.0.1:5000/api/users";
  const CART_API = "http://127.0.0.1:5000/api/cart";
  const params = new URLSearchParams(window.location.search);
  const productId = params.get("product_id");

  function showPopup(message, isError = false) {
    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = "100vw";
    overlay.style.height = "100vh";
    overlay.style.background = "rgba(0,0,0,0.7)";
    overlay.style.display = "flex";
    overlay.style.justifyContent = "center";
    overlay.style.alignItems = "center";
    overlay.style.zIndex = 9999;

    const box = document.createElement("div");
    box.style.background = "#0b1228";
    box.style.padding = "25px";
    box.style.borderRadius = "10px";
    box.style.textAlign = "center";
    box.style.color = isError ? "#ff4b4b" : "#00e0a8";
    box.style.fontSize = "1.2rem";
    box.innerHTML = `<h3>${message}</h3>
      <button id="popupClose" style="margin-top:15px;padding:8px 16px;border:none;border-radius:6px;background:#00b4db;color:#02121a;cursor:pointer;">OK</button>`;

    overlay.appendChild(box);
    document.body.appendChild(overlay);
    document.getElementById("popupClose").addEventListener("click", () => {
      overlay.remove();
      if (!isError) window.location.href = "orders.html";
    });
  }

  document.getElementById("checkoutForm").addEventListener("submit", async (ev) => {
    ev.preventDefault();
    const user_id = localStorage.getItem("user_id");
    if (!user_id) return (window.location.href = "login.html");

    const name = document.getElementById("name").value.trim();
    const address = document.getElementById("address").value.trim();
    const phone = document.getElementById("phone").value.trim();

    const payload = { user_id: parseInt(user_id), name, address, phone };

    try {
      // Update user phone in DB
      await fetch(`${USERS_API}/update-phone`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, phone }),
      });

      // Place order
      let res;
      if (productId) {
        payload.product_id = parseInt(productId);
        res = await fetch(`${ORDERS_API}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } else {
        res = await fetch(`${ORDERS_API}/place`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      const data = await res.json();
      if (res.ok) showPopup("✅ Order placed successfully!");
      else showPopup("❌ " + (data.error || "Failed to place order"), true);
    } catch (err) {
      console.error("Place order error:", err);
      showPopup("Server error placing order", true);
    }
  });

  // Prefill user
  document.addEventListener("DOMContentLoaded", async () => {
    const user_id = localStorage.getItem("user_id");
    if (!user_id) return;
    try {
      const r = await fetch(`${USERS_API}/${user_id}`);
      if (r.ok) {
        const u = await r.json();
        document.getElementById("name").value = u.username || "";
        document.getElementById("phone").value = u.phone || "";
        document.getElementById("address").value = u.address || "";
      }
    } catch {}
  });
</script>
</body>
</html>
