<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Cart — Simple Online Shopping Cart</title>
  <script src="js/auth.js"></script>
  <script>checkLogin();</script>
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Header -->
  <div id="header"></div>

  <main class="cart-page">
    <h2>Your Shopping Cart</h2>
    <div id="cart-items" class="cart-items"></div>
    <div class="cart-summary">
      <h3>Total: ₹<span id="cart-total">0</span></h3>
      <button id="checkout-btn" class="btn-primary">Proceed to Checkout</button>
    </div>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <script>
    // ✅ Load Header & Footer (XAMPP safe)
    fetch("components/header.html")
      .then(r => r.text())
      .then(h => document.getElementById("header").innerHTML = h)
      .catch(err => console.error("Header load failed:", err));

    fetch("components/footer.html")
      .then(r => r.text())
      .then(h => document.getElementById("footer").innerHTML = h)
      .catch(err => console.error("Footer load failed:", err));

    // ✅ Secure fetch wrapper for XAMPP
    function secureFetch(url, options = {}) {
      const base = "http://localhost/simple-online-shopping-cart/backend";
      const fullUrl = url.startsWith("http") ? url : `${base}${url}`;
      return fetch(fullUrl, {
        ...options,
        headers: {
          "Content-Type": "application/json",
          ...(options.headers || {})
        },
        credentials: "include"
      });
    }

    const userId = localStorage.getItem("user_id") || 1;
    const itemsEl = document.getElementById("cart-items");
    const totalEl = document.getElementById("cart-total");

    // ✅ Load Cart Items
    function loadCart() {
      secureFetch(`/api/cart.php?user_id=${userId}`)
        .then(r => r.json())
        .then(items => {
          itemsEl.innerHTML = "";
          let total = 0;

          if (!Array.isArray(items) || items.length === 0) {
            itemsEl.innerHTML = "<p>Your cart is empty.</p>";
            totalEl.textContent = "0";
            return;
          }

          items.forEach(it => {
            total += it.price * it.quantity;
            const div = document.createElement("div");
            div.className = "cart-item";
            div.innerHTML = `
              <img src="../backend/static/uploads/${it.image || 'default.jpg'}" alt="${it.name}">
              <div class="cart-details">
                <h3>${it.name}</h3>
                <p>₹${it.price} × 
                  <input type="number" value="${it.quantity}" min="1" 
                         data-id="${it.product_id}" class="qty-input" style="width:60px">
                </p>
              </div>
              <div>
                <button class="remove-btn" data-id="${it.product_id}">Remove</button>
              </div>
            `;
            itemsEl.appendChild(div);
          });

          totalEl.textContent = total.toFixed(2);

          // Remove item
          document.querySelectorAll(".remove-btn").forEach(btn => {
            btn.addEventListener("click", e => {
              const pid = e.target.dataset.id;
              secureFetch("/api/cart.php?action=remove", {
                method: "POST",
                body: JSON.stringify({ user_id: userId, product_id: pid })
              }).then(() => loadCart());
            });
          });

          // Update quantity
          document.querySelectorAll(".qty-input").forEach(inp => {
            inp.addEventListener("change", e => {
              const pid = e.target.dataset.id;
              const newQty = parseInt(e.target.value) || 1;
              secureFetch("/api/cart.php?action=update", {
                method: "POST",
                body: JSON.stringify({ user_id: userId, product_id: pid, quantity: newQty })
              }).then(() => loadCart());
            });
          });
        })
        .catch(err => {
          console.error("Cart load failed:", err);
          itemsEl.innerHTML = "<p>Unable to load cart.</p>";
        });
    }

    // ✅ Checkout Redirect
    document.getElementById("checkout-btn").addEventListener("click", () => {
      window.location.href = "checkout.html";
    });

    // ✅ Initial Load
    loadCart();
  </script>
</body>
</html>
