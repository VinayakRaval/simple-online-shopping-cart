<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Category ‚Äî ShopSmart Admin</title>
  <style>
    body { font-family:Poppins,sans-serif; background:#0b1220; color:#e6eef8; margin:0; padding:30px; }
    .card {
      background:#071427; border-radius:12px; padding:25px; max-width:900px; margin:auto;
      box-shadow:0 5px 20px rgba(0,0,0,0.5);
    }
    img.category-img {
      width:100%; max-height:300px; object-fit:cover;
      border-radius:10px; margin-bottom:20px; box-shadow:0 3px 10px rgba(0,0,0,0.4);
    }
    h2 { color:#00b4db; margin:10px 0; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; }
    .top-bar button {
      background:#00b4db; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .products {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:20px; margin-top:20px;
    }
    .product-card {
      background:#0f172a; padding:10px; border-radius:8px; text-align:center;
      box-shadow:0 3px 10px rgba(0,0,0,0.4);
    }
    .product-card img {
      width:100%; height:150px; object-fit:cover; border-radius:8px;
    }
    .product-card h4 { margin:8px 0 4px; color:#e6eef8; }
    .product-card p { color:#00e0a8; margin:0; font-weight:600; }
    button.close {
      background:#ff4b4b; border:none; padding:10px 16px; border-radius:8px; cursor:pointer;
      color:white; font-weight:600; margin-top:20px;
    }

    /* ‚úèÔ∏è Modal */
    #editModal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal-content {
      background:#071427; padding:20px; border-radius:12px; width:90%; max-width:400px;
      box-shadow:0 5px 25px rgba(0,0,0,0.6);
    }
    .modal-content h3 { color:#00b4db; margin-top:0; }
    input[type="text"], input[type="file"] {
      width:100%; padding:10px; margin-top:10px; border:none; border-radius:6px;
      background:#0f172a; color:#e6eef8;
    }
    .submit {
      background:#00b4db; border:none; padding:10px; border-radius:8px; font-weight:600; cursor:pointer; margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="card" id="catDetails">Loading...</div>

  <!-- ‚úèÔ∏è Edit Modal -->
  <div id="editModal">
    <div class="modal-content">
      <h3>Edit Category</h3>
      <form id="editForm" enctype="multipart/form-data">
        <input type="hidden" id="editCatId">
        <input type="text" id="editCatName" placeholder="Category Name" required>
        <input type="file" id="editCatImage" accept="image/*">
        <button type="submit" class="submit">üíæ Save Changes</button>
        <button type="button" class="close" onclick="closeModal()">‚úñ Close</button>
      </form>
    </div>
  </div>

  <script>
    const API = "http://127.0.0.1:5000/api/admin";
    const id = new URLSearchParams(window.location.search).get("id");

    async function loadCategory() {
      const res = await fetch(`${API}/category/${id}`);
      const c = await res.json();
      if (c.error) {
        document.getElementById("catDetails").innerHTML = `<p style="color:red;">${c.error}</p>`;
        return;
      }

      const productsHTML = c.products.length
        ? c.products.map(p => `
            <div class="product-card">
              <img src="${API}/images/${p.image}" alt="${p.name}">
              <h4>${p.name}</h4>
              <p>‚Çπ${p.price}</p>
            </div>
          `).join("")
        : "<p>No products in this category yet.</p>";

      document.getElementById("catDetails").innerHTML = `
        <div class="top-bar">
          <h2>${c.name}</h2>
          <div>
            <button onclick="openEditModal(${c.id}, '${c.name}')">‚úèÔ∏è Edit Category</button>
          </div>
        </div>
        <img src="${API}/images/${c.image}" class="category-img" alt="${c.name}">
        <div class="products">${productsHTML}</div>
        <button class="close" onclick="window.close()">Close</button>
      `;
    }

    // ‚úèÔ∏è Edit modal
    function openEditModal(catId, catName) {
      document.getElementById("editCatId").value = catId;
      document.getElementById("editCatName").value = catName;
      document.getElementById("editModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("editModal").style.display = "none";
    }

    // üíæ Save edits
    document.getElementById("editForm").onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById("editCatId").value;
      const fd = new FormData();
      fd.append("name", document.getElementById("editCatName").value);
      const img = document.getElementById("editCatImage").files[0];
      if (img) fd.append("image", img);

      const res = await fetch(`${API}/edit_category/${id}`, { method: "PUT", body: fd });
      if (res.ok) {
        alert("‚úÖ Category updated successfully!");
        closeModal();
        loadCategory(); // Refresh instantly
      } else {
        alert("‚ö†Ô∏è Failed to update category!");
      }
    };

    loadCategory();
  </script>
</body>
</html>
